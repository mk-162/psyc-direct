rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isProjectOwner(projectId) {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid;
    }

    function isProjectEditor(projectId) {
      let project = get(/databases/$(database)/documents/projects/$(projectId)).data;
      return isAuthenticated() &&
             (project.ownerId == request.auth.uid ||
              request.auth.uid in project.editorIds);
    }

    // Projects
    match /projects/{projectId} {
      allow read: if isProjectEditor(projectId);
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isProjectEditor(projectId);
      allow delete: if isProjectOwner(projectId);
    }

    // Categories
    match /categories/{categoryId} {
      allow read: if isAuthenticated() && isProjectEditor(resource.data.projectId);
      allow write: if isAuthenticated() && isProjectEditor(request.resource.data.projectId);
    }

    // Subcategories
    match /subcategories/{subcategoryId} {
      allow read: if isAuthenticated() && isProjectEditor(resource.data.projectId);
      allow write: if isAuthenticated() && isProjectEditor(request.resource.data.projectId);
    }

    // Questions
    match /questions/{questionId} {
      allow read: if isAuthenticated() && isProjectEditor(resource.data.projectId);
      allow write: if isAuthenticated() && isProjectEditor(request.resource.data.projectId);
    }

    // Drafts
    match /drafts/{draftId} {
      allow read: if isAuthenticated() && isProjectEditor(resource.data.projectId);
      allow write: if isAuthenticated() && isProjectEditor(request.resource.data.projectId);
    }

    // Fact Checks
    match /fact_checks/{factCheckId} {
      allow read: if isAuthenticated() && isProjectEditor(resource.data.projectId);
      allow write: if isAuthenticated() && isProjectEditor(request.resource.data.projectId);
    }

    // Jobs
    match /jobs/{jobId} {
      allow read: if isAuthenticated() && isProjectEditor(resource.data.projectId);
      allow write: if isAuthenticated() && isProjectEditor(request.resource.data.projectId);
    }

    // Customers (Stripe)
    match /customers/{userId} {
      allow read: if isAuthenticated() && isOwner(userId);

      match /checkout_sessions/{sessionId} {
        allow read, write: if isAuthenticated() && isOwner(userId);
      }

      match /subscriptions/{subscriptionId} {
        allow read: if isAuthenticated() && isOwner(userId);
      }
    }

    // Products (Stripe)
    match /products/{productId} {
      allow read: if true;

      match /prices/{priceId} {
        allow read: if true;
      }
    }
  }
}
